{"version":3,"file":"uplinks.js","names":["_lodash","_interopRequireDefault","require","_nodeAssert","_core","e","__esModule","default","DEFAULT_REGISTRY","exports","DEFAULT_UPLINK","BLACKLIST","all","anonymous","undefined","owner","none","uplinkSanityCheck","uplinks","users","newUplinks","_","clone","newUsers","uplink","Object","prototype","hasOwnProperty","call","cache","sanityCheckNames","sanityCheckUplinksProps","configUpLinks","assert","url","isString","replace","getProxiesForPackage","pkg","packages","matchedPkg","authUtils","getMatchedPackagesSpec","proxy","hasProxyTo","upLink","proxyList","some","curr","item","match","isNil"],"sources":["../src/uplinks.ts"],"sourcesContent":["import _ from 'lodash';\nimport assert from 'node:assert';\n\nimport { authUtils } from '@verdaccio/core';\nimport { PackageList, UpLinksConfList } from '@verdaccio/types';\n\nexport const DEFAULT_REGISTRY = 'https://registry.npmjs.org';\nexport const DEFAULT_UPLINK = 'npmjs';\n\nconst BLACKLIST = {\n  all: true,\n  anonymous: true,\n  undefined: true,\n  owner: true,\n  none: true,\n};\n\nexport function uplinkSanityCheck(\n  uplinks: UpLinksConfList,\n  users: any = BLACKLIST\n): UpLinksConfList {\n  const newUplinks = _.clone(uplinks);\n  let newUsers = _.clone(users);\n\n  for (const uplink in newUplinks) {\n    if (Object.prototype.hasOwnProperty.call(newUplinks, uplink)) {\n      if (typeof newUplinks[uplink].cache === 'undefined') {\n        newUplinks[uplink].cache = true;\n      }\n      newUsers = sanityCheckNames(uplink, newUsers);\n    }\n  }\n\n  return newUplinks;\n}\n\nexport function sanityCheckUplinksProps(configUpLinks: UpLinksConfList): UpLinksConfList {\n  const uplinks = _.clone(configUpLinks);\n\n  for (const uplink in uplinks) {\n    if (Object.prototype.hasOwnProperty.call(uplinks, uplink)) {\n      assert(uplinks[uplink].url, 'CONFIG: no url for uplink: ' + uplink);\n      assert(_.isString(uplinks[uplink].url), 'CONFIG: wrong url format for uplink: ' + uplink);\n      uplinks[uplink].url = uplinks[uplink].url.replace(/\\/$/, '');\n    }\n  }\n\n  return uplinks;\n}\n\nexport function getProxiesForPackage(pkg: string, packages: PackageList): string[] {\n  const matchedPkg = authUtils.getMatchedPackagesSpec(pkg, packages);\n  return matchedPkg?.proxy || [];\n}\n\nexport function hasProxyTo(pkg: string, upLink: string, packages: PackageList): boolean {\n  const proxyList = getProxiesForPackage(pkg, packages);\n  if (proxyList) {\n    return proxyList.some((curr) => upLink === curr);\n  }\n\n  return false;\n}\n\nexport function sanityCheckNames(item: string, users: any): any {\n  assert(\n    item !== 'all' &&\n      item !== 'owner' &&\n      item !== 'anonymous' &&\n      item !== 'undefined' &&\n      item !== 'none',\n    'CONFIG: reserved uplink name: ' + item\n  );\n  assert(!item.match(/\\s/), 'CONFIG: invalid uplink name: ' + item);\n  assert(_.isNil(users[item]), 'CONFIG: duplicate uplink name: ' + item);\n  users[item] = true;\n\n  return users;\n}\n"],"mappings":"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","ignoreList":[]}