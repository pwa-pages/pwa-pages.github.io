{"version":3,"file":"plugin-async-loader.js","names":["_debug","_interopRequireDefault","require","_lodash","_promises","_nodePath","_core","_utils","e","__esModule","default","debug","buildDebug","isDirectory","pathFolder","stat","lstat","mergeConfig","appConfig","pluginConfig","_","merge","asyncLoadPlugin","pluginConfigs","pluginOptions","sanityCheck","legacyMergeConfigs","prefix","PLUGIN_PREFIX","pluginCategory","logger","pluginsIds","Object","keys","config","plugins","pluginId","isScoped","startsWith","includes","pluginName","pluginsPath","isAbsolute","config_path","configPath","error","resolve","join","dirname","path","pluginDir","externalFilePlugin","plugin","tryLoad","a","b","isValid","executePlugin","content","push","info","err","warn","message","length","originalConfig","isES6"],"sources":["../src/plugin-async-loader.ts"],"sourcesContent":["import buildDebug from 'debug';\nimport _ from 'lodash';\nimport { lstat } from 'node:fs/promises';\nimport { dirname, isAbsolute, join, resolve } from 'node:path';\n\nimport { PLUGIN_PREFIX, pluginUtils } from '@verdaccio/core';\n\nimport { PluginType, isES6, isValid, tryLoad } from './utils';\n\nconst debug = buildDebug('verdaccio:plugin:loader:async');\n\nasync function isDirectory(pathFolder: string) {\n  const stat = await lstat(pathFolder);\n  return stat.isDirectory();\n}\n\nfunction mergeConfig(appConfig: unknown, pluginConfig: unknown) {\n  return _.merge({}, appConfig, pluginConfig);\n}\n\n// type Plugins<T> =\n//   | pluginUtils.Auth<T>\n//   | pluginUtils.Storage<T>\n//   | pluginUtils.ExpressMiddleware<T, unknown, unknown>;\n\n/**\n * The plugin loader find recursively plugins, if one plugin fails is ignored and report the error to the logger.\n *\n * The loader follows the order:\n * - If the at the `config.yaml` file the  `plugins: ./plugins` is defined\n *   - If is absolute will use the provided path\n *   - If is relative, will use the base path of the config file. eg: /root/config.yaml the plugins folder should be\n *     hosted at /root/plugins\n * - The next step is find at the node_modules or global based on the `require` native algorithm.\n * - If the package is scoped eg: @scope/foo, try to load the package `@scope/foo`\n * - If the package is not scoped, will use the default prefix: verdaccio-foo (\"verdaccio-theme-\" prefix for theme ui plugins).\n * - If a custom prefix is provided, the verdaccio- is replaced by the config.server.pluginPrefix.\n *\n * The `sanityCheck` is the validation for the required methods to load the plugin, if the validation fails the plugin won't be loaded.\n * The `params` is an object that contains the global configuration and the logger.\n *\n * @param {*} pluginConfigs the custom plugin section\n * @param {*} pluginOptions a set of options to initialize the plugin\n * @param {*} sanityCheck callback that check the shape that should fulfill the plugin\n * @param {*} prefix by default is verdaccio but can be override with config.server.pluginPrefix\n * @param {*} pluginCategory the category of the plugin, eg: auth, storage, middleware\n * @return {Array} list of plugins\n */\nexport async function asyncLoadPlugin<T extends pluginUtils.Plugin<T>>(\n  pluginConfigs: any = {},\n  pluginOptions: pluginUtils.PluginOptions,\n  sanityCheck: (plugin: PluginType<T>) => boolean,\n  legacyMergeConfigs: boolean = false,\n  prefix: string = PLUGIN_PREFIX,\n  pluginCategory: string = 'unknown'\n): Promise<PluginType<T>[]> {\n  const logger = pluginOptions?.logger;\n  const pluginsIds = Object.keys(pluginConfigs);\n  const { config } = pluginOptions;\n  let plugins: PluginType<T>[] = [];\n  for (let pluginId of pluginsIds) {\n    debug('>>> looking for plugin %o', pluginId);\n\n    const isScoped: boolean = pluginId.startsWith('@') && pluginId.includes('/');\n    debug('is scoped plugin: %s', isScoped);\n    const pluginName = isScoped ? pluginId : `${prefix}-${pluginId}`;\n    debug('plugin package name %s', pluginName);\n\n    // Try to load the plugin from the config.plugins path\n    if (typeof config.plugins === 'string') {\n      let pluginsPath = config.plugins;\n      debug('plugin path %s', pluginsPath);\n      if (!isAbsolute(pluginsPath)) {\n        if (typeof config.config_path === 'string' && !config.configPath) {\n          logger.error(\n            'configPath is missing and the legacy config.config_path is not available for loading plugins'\n          );\n        }\n\n        if (!config.configPath) {\n          logger.error('config path property is required for loading plugins');\n          continue;\n        }\n        pluginsPath = resolve(join(dirname(config.configPath), pluginsPath));\n      }\n      logger.debug({ path: pluginsPath }, 'plugins folder defined, loading plugins from @{path} ');\n      // throws if is not a directory\n      try {\n        await isDirectory(pluginsPath);\n        const pluginDir = pluginsPath;\n        const externalFilePlugin = resolve(pluginDir, pluginName);\n        let plugin = tryLoad<T>(externalFilePlugin, (a: any, b: any) => {\n          logger.error(a, b);\n        });\n        debug('external plugin %o', plugin);\n        if (plugin && isValid(plugin)) {\n          plugin = executePlugin(\n            plugin,\n            pluginConfigs[pluginId],\n            pluginOptions,\n            legacyMergeConfigs\n          );\n          if (!sanityCheck(plugin)) {\n            logger.error(\n              { content: externalFilePlugin },\n              \"@{content} doesn't look like a valid plugin\"\n            );\n            continue;\n          }\n          debug('>>> plugin is running and passed sanity check');\n          plugins.push(plugin);\n          logger.info(\n            { pluginName, pluginCategory },\n            'plugin @{pluginName} successfully loaded (@{pluginCategory})'\n          );\n          continue;\n        }\n      } catch (err: any) {\n        logger.warn(\n          { err: err.message, pluginsPath, pluginName },\n          '@{err} on loading plugins at @{pluginsPath} for @{pluginName}'\n        );\n      }\n    }\n\n    // Try to load the plugin from the node_modules or global based on the `require` native algorithm\n    if (typeof pluginId === 'string') {\n      let plugin = tryLoad<T>(pluginName, (a: any, b: any) => {\n        logger.error(a, b);\n      });\n      if (plugin && isValid(plugin)) {\n        plugin = executePlugin(plugin, pluginConfigs[pluginId], pluginOptions, legacyMergeConfigs);\n        if (!sanityCheck(plugin)) {\n          logger.error({ pluginName }, \"@{pluginName} doesn't look like a valid plugin\");\n          continue;\n        }\n        debug('>>> plugin is running and passed sanity check');\n        plugins.push(plugin);\n        logger.info(\n          { pluginName, pluginCategory },\n          'plugin @{pluginName} successfully loaded (@{pluginCategory})'\n        );\n        continue;\n      } else {\n        logger.error(\n          { pluginName },\n          'package not found, try to install @{pluginName} with a package manager'\n        );\n        continue;\n      }\n    }\n  }\n  debug('%o plugins found: %o', pluginCategory, plugins.length);\n  return plugins;\n}\n\nexport function executePlugin<T>(\n  plugin: PluginType<T>,\n  pluginConfig: unknown,\n  pluginOptions: pluginUtils.PluginOptions,\n  legacyMergeConfigs: boolean = false\n): PluginType<T> {\n  // this is a legacy support for plugins that are not using the new API\n  if (legacyMergeConfigs) {\n    debug('>>> plugin merge config enabled');\n    let originalConfig = pluginOptions.config;\n    pluginConfig = mergeConfig(originalConfig, pluginConfig);\n  }\n  if (isES6(plugin)) {\n    debug('plugin is ES6');\n    // @ts-expect-error no relevant for the code\n    // eslint-disable-next-line new-cap\n    return new plugin.default(pluginConfig, pluginOptions) as Plugin;\n  } else {\n    debug('plugin is commonJS');\n    // @ts-expect-error improve this type\n    return plugin(pluginConfig, pluginOptions) as PluginType<T>;\n  }\n}\n"],"mappings":"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","ignoreList":[]}