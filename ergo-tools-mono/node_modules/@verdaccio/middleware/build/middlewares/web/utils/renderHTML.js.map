{"version":3,"file":"renderHTML.js","names":["_debug","_interopRequireDefault","require","_lruCache","_nodePath","_nodeUrl","_config","_core","_url","_template","_webUtils","e","__esModule","default","DEFAULT_LANGUAGE","cache","LRU","max","ttl","debug","buildDebug","defaultManifestFiles","js","ico","css","resolveLogo","logo","url_prefix","requestOptions","isLocalFile","isURLhasValidProtocol","getPublicUrl","path","basename","renderHTML","config","manifest","manifestFiles","res","base","URL","pathname","language","i18n","web","hideDeprecatedVersions","needHtmlCache","undefined","includes","html_cache","darkMode","title","WEB_TITLE","login","hasLogin","scope","favicon","logoDark","pkgManagers","version","locals","app_version","flags","experiments","primaryColor","validatePrimaryColor","primary_color","scriptsBodyAfter","metaScripts","scriptsbodyBefore","showInfo","showSettings","showThemeSwitch","showFooter","showSearch","showDownloadTarball","showRaw","showUplinks","Object","assign","bodyBefore","scriptsBodyBefore","options","webPage","cacheKey","JSON","stringify","get","renderTemplate","set","error","Error","stack","setHeader","HEADERS","TEXT_HTML","send"],"sources":["../../../../src/middlewares/web/utils/renderHTML.ts"],"sourcesContent":["import buildDebug from 'debug';\nimport type { Response } from 'express';\nimport LRU from 'lru-cache';\nimport path from 'node:path';\nimport { URL } from 'node:url';\n\nimport { WEB_TITLE } from '@verdaccio/config';\nimport { HEADERS } from '@verdaccio/core';\nimport { ConfigYaml, TemplateUIOptions } from '@verdaccio/types';\nimport type { RequestOptions } from '@verdaccio/url';\nimport { getPublicUrl, isURLhasValidProtocol } from '@verdaccio/url';\n\nimport type { Manifest } from './manifest';\nimport renderTemplate from './template';\nimport type { WebpackManifest } from './template';\nimport { hasLogin, validatePrimaryColor } from './web-utils';\n\nconst DEFAULT_LANGUAGE = 'es-US';\nconst cache = new LRU({ max: 500, ttl: 1000 * 60 * 60 });\n\nconst debug = buildDebug('verdaccio:web:render');\n\nconst defaultManifestFiles: Manifest = {\n  js: ['runtime.js', 'vendors.js', 'main.js'],\n  ico: 'favicon.ico',\n  css: [],\n};\n\nexport function resolveLogo(\n  logo: string | undefined,\n  url_prefix: string | undefined,\n  requestOptions: RequestOptions\n) {\n  if (typeof logo !== 'string') {\n    return '';\n  }\n  const isLocalFile = logo && !isURLhasValidProtocol(logo);\n\n  if (isLocalFile) {\n    return `${getPublicUrl(url_prefix, requestOptions)}-/static/${path.basename(logo)}`;\n  } else if (isURLhasValidProtocol(logo)) {\n    return logo;\n  } else {\n    return '';\n  }\n}\n\nexport default function renderHTML(\n  config: ConfigYaml,\n  manifest: WebpackManifest,\n  manifestFiles: Manifest | null | undefined,\n  requestOptions: RequestOptions,\n  res: Response\n) {\n  const { url_prefix } = config;\n  const base = getPublicUrl(config?.url_prefix, requestOptions);\n  const basename = new URL(base).pathname;\n  const language = config?.i18n?.web ?? DEFAULT_LANGUAGE;\n  const hideDeprecatedVersions = config?.web?.hideDeprecatedVersions ?? false;\n  // @ts-ignore\n  const needHtmlCache = [undefined, null].includes(config?.web?.html_cache)\n    ? true\n    : config?.web?.html_cache;\n  const darkMode = config?.web?.darkMode ?? false;\n  const title = config?.web?.title ?? WEB_TITLE;\n  const login = hasLogin(config);\n  const scope = config?.web?.scope ?? '';\n  const favicon = resolveLogo(config?.web?.favicon, config?.url_prefix, requestOptions);\n  const logo = resolveLogo(config?.web?.logo, config?.url_prefix, requestOptions);\n  const logoDark = resolveLogo(config?.web?.logoDark, config?.url_prefix, requestOptions);\n  const pkgManagers = config?.web?.pkgManagers ?? ['yarn', 'pnpm', 'npm'];\n  const version = res.locals.app_version ?? '';\n  const flags = {\n    ...config.flags,\n    // legacy from 5.x\n    ...config.experiments,\n  };\n  const primaryColor =\n    validatePrimaryColor(config?.web?.primary_color ?? config?.web?.primaryColor) ?? '#4b5e40';\n  const {\n    scriptsBodyAfter,\n    metaScripts,\n    scriptsbodyBefore, // deprecated\n    showInfo,\n    showSettings,\n    showThemeSwitch,\n    showFooter,\n    showSearch,\n    showDownloadTarball,\n    showRaw,\n    showUplinks,\n  } = Object.assign(\n    {},\n    {\n      scriptsBodyAfter: [],\n      bodyBefore: [],\n      metaScripts: [],\n    },\n    config?.web\n  );\n  // Fallback\n  let scriptsBodyBefore = config?.web?.scriptsBodyBefore;\n  if (scriptsbodyBefore && !scriptsBodyBefore) {\n    scriptsBodyBefore = scriptsbodyBefore;\n  }\n  const options: TemplateUIOptions = {\n    showInfo,\n    showSettings,\n    showThemeSwitch,\n    showFooter,\n    showSearch,\n    showDownloadTarball,\n    showRaw,\n    showUplinks,\n    darkMode,\n    url_prefix,\n    basename,\n    base,\n    primaryColor,\n    version,\n    logo,\n    logoDark,\n    favicon,\n    flags,\n    login,\n    pkgManagers,\n    title,\n    scope,\n    language,\n    hideDeprecatedVersions,\n  };\n\n  let webPage;\n\n  let cacheKey = `template:${JSON.stringify(options)}`;\n\n  try {\n    webPage = cache.get(cacheKey);\n    if (!webPage) {\n      webPage = renderTemplate(\n        {\n          manifest: manifestFiles ?? defaultManifestFiles,\n          options,\n          scriptsBodyAfter,\n          metaScripts,\n          scriptsBodyBefore,\n        },\n        manifest\n      );\n\n      if (needHtmlCache) {\n        cache.set(cacheKey, webPage);\n        debug('set template cache');\n      }\n    } else {\n      debug('reuse template cache');\n    }\n  } catch (error: any) {\n    throw new Error(`theme could not be load, stack ${error.stack}`);\n  }\n  res.setHeader('Content-Type', HEADERS.TEXT_HTML);\n  res.send(webPage);\n  debug('web rendered');\n}\n"],"mappings":"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","ignoreList":[]}